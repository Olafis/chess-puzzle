# PRD: 체스 퍼즐 플랫폼

## 1. 개요

### 제품 비전
리체스(Lichess) 실전 경기 데이터를 기반으로 퍼즐을 자동 생성하고, 유저가 기사 스타일별·전술 카테고리별로 퍼즐을 풀며 레이팅을 겨루는 체스 퍼즐 플랫폼.

### 핵심 차별점
- **기사 스타일 퍼즐팩**: Magnus Carlsen, Tal, Fischer 등 유명 기사의 실전 경기에서 추출한 퍼즐 제공
- **복합 필터링**: 기사 × 전술 카테고리 × 오프닝 × 난이도 조합 검색
- **커뮤니티 퀄리티 관리**: 유저가 퍼즐 품질을 직접 평가하고 카테고리를 재분류
- **기사 스타일 유사도**: 퍼즐에서 선택한 수를 기반으로 유저의 플레이 스타일 분석

---

## 2. 타겟 유저

| 세그먼트 | 특징 | 핵심 니즈 |
|---------|------|---------|
| 입문자 | 레이팅 800 이하 | 쉬운 전술 반복 학습 |
| 중급자 | 레이팅 1000~1800 | 약점 전술 집중 훈련 |
| 고급자 | 레이팅 1800 이상 | 고난이도 복합 전술, 기사 스타일 연구 |

---

## 3. 핵심 기능

### 3.1 퍼즐 생성 파이프라인 (내부 시스템)

**입력**: 리체스 PGN 경기 파일

**처리 흐름**:
1. PGN 파싱 → 각 포지션 추출
2. Stockfish (depth ≥ 20)으로 각 수 분석
3. 평가값 변화 ≥ ±2.0 포인트인 지점 탐지 (블런더 감지)
4. 블런더 직전 포지션을 퍼즐 시작점으로 설정
5. 정답 수순이 강제적인지 검증 (차선수와 최선수의 차이 ≥ 1.5)
6. 전술 패턴 자동 태깅
7. PostgreSQL에 저장

**퍼즐 필터링 기준**:
- 최소 수순 2수 이상
- 정답이 유일해야 함 (차선수와 격차 필수)
- 엔진 분석 depth 20 이상

### 3.2 퍼즐 분류 시스템

#### 기사 태그
- 해당 경기를 플레이한 기사 자동 태깅
- 기사 프로필 페이지에서 해당 기사 퍼즐만 필터링 가능

#### 전술 카테고리 (자동 감지)
| 카테고리 | 설명 |
|---------|------|
| 포크 (Fork) | 한 수로 두 기물 이상 동시 공격 |
| 핀 (Pin) | 기물이 뒤의 고가치 기물을 보호하는 라인에 고정 |
| 스큐어 (Skewer) | 고가치 기물이 앞에 있고 뒤의 기물 위협 |
| 발견 공격 (Discovered Attack) | 기물 이동으로 뒤 기물의 공격선 개방 |
| 이중 체크 (Double Check) | 두 기물이 동시에 킹을 공격 |
| 메이트 인 1~5 | 몇 수 안에 메이트 가능 |
| 퀸 희생 (Queen Sacrifice) | 퀸을 내주고 이기는 수순 |
| 룩 엔드게임 | 룩룩만 남은 엔드게임 전술 |
| 폰 프로모션 | 폰 승진을 활용한 전술 |
| 트랩 | 오프닝/미들게임 함정 |

#### 경기 단계
- 오프닝 (수 1~15)
- 미들게임 (수 16~40)
- 엔드게임 (수 41+, 또는 기물 수 기준)

#### 오프닝
- ECO 코드 기반 자동 태깅 (A00~E99)
- 예: 시칠리안 나이도르프, 루이 로페즈, 킹스 인디언 등

### 3.3 퍼즐 풀기

**기본 플로우**:
1. 퍼즐 포지션 표시 (어느 색이 풀어야 하는지 안내)
2. 유저가 수 입력
3. 정답이면 다음 강제 응수 표시 → 최종 정답까지 반복
4. 오답이면 틀렸다고 표시 (힌트 옵션 제공)
5. 풀기 완료 후 피드백 UI 표시

**힌트 시스템**:
- 힌트 1회 사용 시 레이팅 획득량 감소
- 힌트: 공격받는 기물 강조 표시

**경기 연결**:
- 퍼즐 풀기 완료 후 "이 경기 전체 보기" 버튼
- 해당 경기 기보 리플레이 페이지로 이동

### 3.4 레이팅 시스템

**알고리즘**: Glicko-2 (리체스와 동일)

**레이팅 구조**:
- 전체 통합 레이팅
- 전술 카테고리별 레이팅 (포크 레이팅, 핀 레이팅 등)
- 기사 스타일팩별 레이팅

**레이팅 변동**:
- 퍼즐 정답 → 레이팅 상승 (퍼즐 레이팅 - 유저 레이팅 기반 조정)
- 퍼즐 오답 → 레이팅 하락
- 힌트 사용 → 변동폭 50% 감소

### 3.5 커뮤니티 피드백

퍼즐 완료 후 표시되는 피드백 UI:

**좋아요 / 싫어요**
- 전체 평점으로 집계
- 싫어요 비율 30% 초과 시 자동 숨김 + 관리자 검토 큐

**카테고리 재분류**
- 현재 카테고리가 틀렸다고 생각하면 올바른 카테고리 투표
- 투표 집계 시 다수결로 자동 업데이트 (최소 10표 이상)

**신고 유형**
| 신고 사유 | 자동 처리 |
|---------|---------|
| 정답이 여러 개 있음 | 엔진 재분석 큐 등록 |
| 난이도가 잘못됨 | 난이도 레이팅 재조정 |
| 퍼즐이 의미없음 | 5건 이상 시 즉시 숨김 |
| 카테고리 오분류 | 카테고리 투표로 처리 |

### 3.6 기사 스타일 분석

- 유저가 선택한 수의 패턴을 분석
- 각 기사의 전형적인 전술 패턴과 비교
- 프로필 페이지에 "당신의 스타일" 표시
  - 예: "공격형 (Tal 스타일 73% 유사)"
  - 주로 사용하는 전술 패턴 차트

---

## 4. 페이지 구성

### 4.1 메인 페이지 (`/`)
- 오늘의 퍼즐 (Daily Puzzle)
- 인기 기사 스타일팩 카드
- 최근 활동 피드 (누가 어떤 퍼즐 풀었는지)
- 내 레이팅 요약 (로그인 시)

### 4.2 퍼즐 풀기 (`/puzzle/[id]`)
- 체스보드 (react-chessboard)
- 퍼즐 정보 (기사, 카테고리, 난이도)
- 힌트 버튼
- 완료 후 피드백 UI
- 다음 퍼즐 버튼

### 4.3 퍼즐 탐색 (`/puzzles`)
- 필터: 기사 / 전술 카테고리 / 오프닝 / 난이도 / 경기 단계
- 다중 필터 조합 가능
- 정렬: 인기순 / 최신순 / 난이도순

### 4.4 기사 페이지 (`/player/[name]`)
- 기사 프로필 및 커리어 요약
- 해당 기사 경기에서 추출한 퍼즐 목록
- 대표 전술 패턴 통계

### 4.5 경기 기보 (`/game/[id]`)
- 전체 기보 리플레이어
- 이 경기에서 추출된 퍼즐 목록
- Stockfish 분석 그래프 (평가값 변화)

### 4.6 내 프로필 (`/profile/[username]`)
- 레이팅 그래프 (기간별)
- 카테고리별 레이팅 레이더 차트
- 풀기 통계 (정답률, 총 시도 수)
- 기사 스타일 유사도
- 활동 히트맵 (GitHub 잔디 스타일)

### 4.7 리더보드 (`/leaderboard`)
- 전체 랭킹
- 카테고리별 랭킹
- 주간 / 월간 / 전체 기간 필터

---

## 5. 기술 스택

### 프론트엔드 + API
| 기술 | 역할 |
|------|------|
| Next.js 14 (App Router) | 웹 서버, SSR, API Routes |
| React | UI 컴포넌트 |
| react-chessboard | 체스보드 렌더링 |
| chess.js | 체스 규칙 엔진 (클라이언트) |
| Tailwind CSS | 스타일링 |
| Prisma ORM | DB 스키마 관리 |
| NextAuth.js | 인증 (Google, GitHub, 이메일) |

### 데이터베이스
| 기술 | 역할 |
|------|------|
| PostgreSQL | 메인 DB |
| Redis | 세션, 캐시 (레이팅 계산 등) |

### 퍼즐 생성 파이프라인 (별도)
| 기술 | 역할 |
|------|------|
| Python 3.11+ | 파이프라인 언어 |
| python-chess | PGN 파싱, 포지션 분석 |
| Stockfish 16 | 체스 엔진 분석 |
| psycopg2 | PostgreSQL 연결 |
| Click | CLI 인터페이스 |

---

## 6. 데이터 모델 (주요 테이블)

```
User
├── id, username, email
├── rating (전체)
├── style_profile (JSON: 기사별 유사도)
└── created_at

Puzzle
├── id
├── fen (시작 포지션)
├── moves (정답 수순, UCI 포맷)
├── rating
├── source_game_id
├── player_white, player_black
├── themes (전술 카테고리 배열)
├── opening_eco, opening_name
├── game_phase (opening/middlegame/endgame)
├── like_count, dislike_count
└── is_active

Game
├── id
├── pgn
├── white_player, black_player
├── event, date, result
└── source (lichess game id)

PuzzleAttempt
├── id, user_id, puzzle_id
├── solved (boolean)
├── hint_used (boolean)
├── time_spent_seconds
├── rating_before, rating_after
└── created_at

PuzzleFeedback
├── id, user_id, puzzle_id
├── vote (like / dislike / null)
├── report_type (null / multiple_solutions / wrong_difficulty / nonsense)
└── created_at

PuzzleCategoryVote
├── id, user_id, puzzle_id
├── suggested_theme
└── created_at
```

---

## 7. 퍼즐 생성 파이프라인 상세

```
python scripts/generate_puzzles.py --pgn games.pgn --depth 20 --min-advantage 2.0

1. PGN 파일에서 경기 파싱
2. 각 경기의 수마다 Stockfish 분석
3. 블런더 탐지 (평가값 변화 ≥ 2.0)
4. 정답 수순 추출 및 유효성 검증
   - 최선수와 차선수 격차 ≥ 1.5
   - 수순 길이 ≥ 2수
5. 전술 패턴 태깅
6. 오프닝 ECO 분류
7. 중복 퍼즐 필터링 (동일 FEN 체크)
8. DB 저장
```

---

## 8. MVP 범위 (1차 출시)

### 포함
- [ ] 퍼즐 생성 파이프라인 (Python)
- [ ] 퍼즐 풀기 페이지
- [ ] 전술 카테고리 필터링
- [ ] 기본 레이팅 시스템 (Glicko-2)
- [ ] 유저 가입/로그인
- [ ] 커뮤니티 피드백 (좋아요/싫어요/신고)
- [ ] 프로필 페이지 (레이팅, 통계)

### MVP 이후 (2차)
- [ ] 기사 스타일 분석
- [ ] 기사 프로필 페이지
- [ ] 경기 기보 리플레이어
- [ ] 리더보드
- [ ] Daily Puzzle
- [ ] 카테고리 재분류 투표

---

## 9. 비기능 요구사항

| 항목 | 목표 |
|------|------|
| 퍼즐 로딩 속도 | 200ms 이하 |
| 퍼즐 DB 초기 목표 | 10,000개 이상 |
| 동시 접속자 | 1,000명 |
| 모바일 지원 | 반응형 웹 (모바일 체스보드 터치 지원) |
| 다국어 | 한국어 / 영어 (1차 출시) |
